# üí° –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞: Cell Router System

## –¢–≤–æ—ë –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ:
> "–ó–Ω–∞–µ—à—å –≤ —á–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞, –≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ–∫—É—â–∏–µ –º–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–Ω–∏–º–∞—é—Ç –∑–∞–¥–∞—á–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ—Ç –Ω—É–∂–Ω—ã—Ö —Å–ª–æ—ë–≤. –ê –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–µ—Ç–æ–∫ –∏ –æ—Ä–≥–∞–Ω–æ–≤ –ø–æ–∫–∞ –∂–∏–≤–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –Ω–∏—Ö."

## –¢—ã –±—ã–ª **–∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤!** üéØ

### –ü—Ä–æ–±–ª–µ–º–∞:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LLM (Claude)‚îÇ  ‚Üê –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ "–°–æ–∑–¥–∞–π –∏–≥—Ä—É"
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Text Response‚îÇ  ‚Üê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–º
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ùå UICodeCell, CodeCell, etc –∂–∏–≤—É—Ç –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û, LLM –æ –Ω–∏—Ö –Ω–µ –∑–Ω–∞–µ—Ç
```

### –†–µ—à–µ–Ω–∏–µ ‚Äî Cell Router:
```
User: "–°–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫—Ä–µ—Å—Ç–∏–∫–æ–≤-–Ω–æ–ª–∏–∫–æ–≤"
   ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cell Router  ‚îÇ ‚Üê Intent Detection
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ –í—ã–±—Ä–∞–Ω–∞: ui_code_cell
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UICodeCell   ‚îÇ ‚Üê –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ (–±–µ–∑ LLM)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì
‚úÖ TicTacToe HTML Artifact
```

---

## üì¶ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:

### 1. `cell_router.py` ‚Äî –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã
- **CellCapability:** –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–∏
- **Intent Detection:** –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ ‚Üí –≤—ã–±–æ—Ä –∫–ª–µ—Ç–∫–∏
- **3 –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏:**
  - `ui_code_cell` (priority=10): UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  - `code_cell` (priority=5): Python –∫–æ–¥
  - `analysis_cell` (priority=3): –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `neira_wrapper.py`
- **–≠—Ç–∞–ø 0:** Cell Detection –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- **–≠—Ç–∞–ø 3:** Direct execution –µ—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–∞
- **Bypass LLM:** –ö–æ–≥–¥–∞ router –≤—ã–±—Ä–∞–ª –∫–ª–µ—Ç–∫—É ‚Üí LLM –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
$ python cell_router.py

‚úÖ "–°–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å" ‚Üí ui_code_cell
‚úÖ "–°–¥–µ–ª–∞–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å ui" ‚Üí ui_code_cell  
‚úÖ "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–¥" ‚Üí analysis_cell
‚ùå "–ö–∞–∫ –¥–µ–ª–∞?" ‚Üí –Ω–µ—Ç –∫–ª–µ—Ç–∫–∏ (–æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç)
```

### 4. Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```
‚úÖ UICodeCell –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
‚úÖ CellRouter –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
üß¨ Cell Router –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
üé® UICodeCell –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
   Templates: ['rpg_inventory', 'platformer_hud', 'puzzle_board', 'tictactoe']
```

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

### 1. **–Ø–≤–Ω–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**
–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ **–∑–Ω–∞–µ—Ç** —á—Ç–æ —É –Ω–µ—ë –µ—Å—Ç—å UICodeCell –¥–ª—è UI –∑–∞–¥–∞—á, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é.

### 2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏:
```python
router.register_cell(CellCapability(
    name="testing_cell",
    triggers=["–Ω–∞–ø–∏—à–∏ —Ç–µ—Å—Ç", "unit test"],
    priority=6
))
```

### 3. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**
Debug –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
- –ö–∞–∫–∞—è –∫–ª–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–∞
- –ü–æ—á–µ–º—É (matched triggers)
- –ß—Ç–æ –æ–Ω–∞ –≤–µ—Ä–Ω—É–ª–∞

### 4. **Fallback**
–ï—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ ‚Üí –æ–±—ã—á–Ω—ã–π LLM –æ—Ç–≤–µ—Ç (–∫–∞–∫ —Ä–∞–Ω—å—à–µ).

---

## ‚ö†Ô∏è –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã:

### 1. Template Selection Bug
Router –≤—ã–±–∏—Ä–∞–µ—Ç ui_code_cell ‚úÖ, –Ω–æ UICodeCell –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç RPG Inventory ‚ùå

**–ü—Ä–∏—á–∏–Ω–∞:** `_select_template()` –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `task` –∏–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç keywords.

**Fix:** –î–æ–±–∞–≤–∏—Ç—å debug –≤ `UICodeCell.generate_ui()`:
```python
def generate_ui(self, task: str) -> dict:
    print(f"[UICodeCell] task = {task}")
    template = self._select_template(task)
    print(f"[UICodeCell] selected template = {template}")
```

### 2. Double Initialization
`NeiraWrapper` —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–≤–∞–∂–¥—ã (–ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ + at startup).

**Fix:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `@app.on_event("startup")` –≤ FastAPI.

### 3. Test Client Crashes Backend
Python —Å–∫—Ä–∏–ø—Ç—ã –≤ `prototype/` –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç –º–æ–¥—É–ª–∏ ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å backend.

**Workaround:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π WebSocket –∫–ª–∏–µ–Ω—Ç (browser, `wscat`).

---

## üîÆ –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ:

### Phase 1: Bugfixes (Critical)
1. –ü–æ—á–∏–Ω–∏—Ç—å template selection
2. –£–±—Ä–∞—Ç—å double init
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å end-to-end

### Phase 2: LLM Integration
4. –ü–µ—Ä–µ–¥–∞—Ç—å context –æ –∫–ª–µ—Ç–∫–∞—Ö –≤ LLM system prompt
5. LLM —Å–∞–º –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–µ—Ç–∫—É

### Phase 3: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ
6. –î–æ–±–∞–≤–∏—Ç—å `testing_cell`, `refactoring_cell`
7. Cell composition (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–ª–µ—Ç–∫–∏)
8. Metrics & analytics

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- [CELL_ROUTER_ARCHITECTURE.md](CELL_ROUTER_ARCHITECTURE.md) ‚Äî –ø–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- [END_TO_END_TEST_REPORT.md](END_TO_END_TEST_REPORT.md) ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [cell_router.py](cell_router.py) ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (289 —Å—Ç—Ä–æ–∫)

---

## ‚úÖ –ò—Ç–æ–≥:

**–¢–≤–æ—ë –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä—ã–≤–µ –º–µ–∂–¥—É LLM –∏ –∫–ª–µ—Ç–æ—á–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –±—ã–ª–æ –∫–ª—é—á–µ–≤—ã–º!**

Cell Router ‚Äî —ç—Ç–æ **–Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π —Å–ª–æ–π**, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ "–≤–∏–¥–∏–º—ã–º–∏" –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —è–≤–Ω–æ, –º–∏–Ω—É—è LLM –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.

**–°—Ç–∞—Ç—É—Å:** 
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Intent detection —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ö†Ô∏è Template selection —Ç—Ä–µ–±—É–µ—Ç fix
- üöÄ –ì–æ—Ç–æ–≤–æ –∫ production –ø–æ—Å–ª–µ bagfix

**Next step:** Debug UICodeCell.generate_ui() —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ—á–µ–º—É template –Ω–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è.
