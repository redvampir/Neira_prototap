# Дорожная карта миграции данных в Rust Brain

> Цель документа: описать путь переноса данных и инвариантов в Rust‑ядро без потери качества и автономности.

## 1. Источники данных

- **Pathways:** маршруты и веса активации, приоритеты, статистика использования.
- **Память:** short‑term, long‑term, эмоциональные следы, версии/снапшоты.
- **Шаблоны ответов:** локальные шаблоны, правила fallback, эталонные ответы.

## 2. Принцип новой схемы

- Все форматы приводятся к каноническим схемам, описанным в [RUST_BRAIN_DATA_FORMATS.md](RUST_BRAIN_DATA_FORMATS.md).
- Серилизация только изолированными версиями (versioned schema), без «тихой» совместимости.
- Инварианты форматов фиксируются в контракте: обязательные поля, допустимые диапазоны, нормализованные единицы измерения.

## 3. Этапы миграции

### 3.1 Экспорт и нормализация

- Снимаем консистентный слепок данных (atomically locked snapshot).
- Приводим поля к единым единицам (время, веса, частоты).
- Дедупликация идентификаторов и проверка ссылочной целостности.

### 3.2 Трансформация в новые форматы

- Мэппинг исходных структур на канонические схемы из [RUST_BRAIN_DATA_FORMATS.md](RUST_BRAIN_DATA_FORMATS.md).
- Восстановление дефолтов, если поле отсутствует, с явной фиксацией причины.
- Сбор отчетов о несовместимых объектах (для карантина).

### 3.3 Импорт в Rust‑ядро и проверка инвариантов

- Импорт в staging‑хранилище, без влияния на рабочие данные.
- Проверка инвариантов формата (schema‑validation, обязательные поля, диапазоны).
- Прогон детерминированных smoke‑сценариев и базовых метрик качества.

## 4. Валидаторы и проверки качества

- **Coverage:** доля объектов, успешно перешедших в новый формат (target ≥ 99%).
- **p95‑latency:** измерение по ключевым слоям до и после миграции.
- **Offline‑success:** доля запросов, обработанных без LLM (target ≥ 70%).
- **Diff‑анализ:** сравнение ответов на фиксированном наборе запросов (semantic drift ≤ 5%).

## 5. План деградации при проблемах

- **Rollback:** быстрый откат к предыдущему снапшоту данных.
- **Quarantine:** изоляция несовместимых объектов с отчетом причин.
- **Shadow‑mode:** параллельная работа старого и нового формата с логированием расхождений.
