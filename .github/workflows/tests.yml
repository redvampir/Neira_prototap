name: Ð¢ÐµÑÑ‚Ñ‹ Ð¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð°

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð° (Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ)
  # ============================================
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
        run: |
          python scripts/validate_code.py --all
        continue-on-error: false

      - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² ÐºÐ¾Ñ€Ð½Ðµ..."
          # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² ÐºÐ¾Ñ€Ð½Ðµ
          ALLOWED="main.py neira.py telegram_bot.py neira_server.py requirements.txt pytest.ini setup.py conftest.py"
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²ÑÐµ .py Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÐºÐ¾Ñ€Ð½Ðµ
          for f in *.py; do
            if [ -f "$f" ]; then
              if ! echo "$ALLOWED" | grep -qw "$f"; then
                echo "âš ï¸ WARNING: $f Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² neira/ Ð¸Ð»Ð¸ scripts/)"
              fi
            fi
          done

  # ============================================
  # Ð¢ÐµÑÑ‚Ñ‹
  # ============================================
  tests:
    runs-on: ubuntu-latest
    needs: quality  # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ quality Ð¿Ñ€Ð¾ÑˆÑ‘Ð»
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests numpy duckduckgo-search
          fi

      - name: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
        run: |
          mkdir -p artifacts
          python -m pytest tests/test_basic.py -v --tb=short
          
      - name: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹
        run: |
          python -m pytest tests/ -v --tb=short -m "not slow and not integration" \
            --cov=. --cov-report=xml:artifacts/coverage.xml \
            --junitxml=artifacts/junit.xml \
            2>&1 | tee artifacts/test.log || true

      - name: Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: artifacts/
          if-no-files-found: ignore
