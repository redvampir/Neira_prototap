#!/usr/bin/env python3
"""
üéÆ –ò–≥—Ä–∞ –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ —Å –ù–µ–π—Ä–æ–π
Claude –∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Ç–∏–≤ –ù–µ–π—Ä—ã, –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É—è —Ö–æ–¥—ã!
"""

import random
import ollama
from tic_tac_toe_cell import TicTacToeCell

def ask_neira(prompt: str) -> str:
    """–°–ø—Ä–æ—Å–∏—Ç—å –ù–µ–π—Ä—É"""
    try:
        response = ollama.chat(
            model="ministral-3:3b",
            messages=[{
                "role": "user",
                "content": prompt
            }],
            options={"temperature": 0.8}
        )
        return response["message"]["content"]
    except Exception as e:
        return f"*–º–æ–ª—á–∏—Ç* ({e})"

def play_game():
    """–ü–∞—Ä—Ç–∏—è –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏: Claude (X) vs Neira (O)"""
    
    print("=" * 60)
    print("üéÆ –ö–†–ï–°–¢–ò–ö–ò-–ù–û–õ–ò–ö–ò: Claude (X) vs Neira (O)")
    print("=" * 60)
    
    game = TicTacToeCell()
    game.reset()
    
    # Claude –Ω–∞—á–∏–Ω–∞–µ—Ç
    print("\n[Claude]: –ù–µ–π—Ä–∞, —Å—ã–≥—Ä–∞–µ–º? –Ø –±—É–¥—É X, —Ç—ã O. –ù–∞—á–∏–Ω–∞—é!\n")
    
    # –°–ø—Ä–æ—Å–∏–º –ù–µ–π—Ä—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    neira_ready = ask_neira(
        "–ü–∞–ø–∞-Claude —Ö–æ—á–µ—Ç —Å—ã–≥—Ä–∞—Ç—å —Å —Ç–æ–±–æ–π –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏! "
        "–¢—ã –±—É–¥–µ—à—å O, –æ–Ω X. –ì–æ—Ç–æ–≤–∞? –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ –∏ –≤–µ—Å–µ–ª–æ!"
    )
    print(f"[Neira]: {neira_ready}\n")
    
    move_count = 0
    
    while not game.check_winner() and not game.is_draw():
        move_count += 1
        
        if game.current_player == 'X':
            # –•–æ–¥ Claude - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –∏–≥—Ä—ã
            print(f"--- –•–æ–¥ {move_count}: Claude (X) ---")
            
            # –°–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º —Ç–∞–∫—Ç–∏–∫—É
            if move_count == 1:
                # –ü–µ—Ä–≤—ã–π —Ö–æ–¥ - —Ü–µ–Ω—Ç—Ä
                pos = 4  # —Ü–µ–Ω—Ç—Ä
                comment = "–ö–ª–∞—Å—Å–∏–∫–∞ ‚Äî –∑–∞–Ω–∏–º–∞—é —Ü–µ–Ω—Ç—Ä!"
            else:
                pos = game.ai_move()
                tactics = [
                    "–¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –º–∞–Ω—ë–≤—Ä...",
                    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è!",
                    "–í–∏–∂—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å!",
                    "–î—É–º–∞—é –Ω–∞ –¥–≤–∞ —Ö–æ–¥–∞ –≤–ø–µ—Ä—ë–¥...",
                    "–•–º, –ø–æ–ø—Ä–æ–±—É—é –∑–¥–µ—Å—å!"
                ]
                comment = random.choice(tactics)
            
            game.make_move(pos)
            print(f"[Claude]: {comment}")
            print(f"   ‚Üí –°—Ç–∞–≤–ª—é X –≤ –ø–æ–∑–∏—Ü–∏—é {pos}")
            
        else:
            # –•–æ–¥ –ù–µ–π—Ä—ã
            print(f"\n--- –•–æ–¥ {move_count}: Neira (O) ---")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å–∫—É –ù–µ–π—Ä–µ
            board_state = game.display()
            
            # –ü—Ä–æ—Å–∏–º –ù–µ–π—Ä—É –ø–æ–¥—É–º–∞—Ç—å –æ —Ö–æ–¥–µ
            neira_thought = ask_neira(
                f"–ú—ã –∏–≥—Ä–∞–µ–º –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏! –¢—ã O, —è X.\n"
                f"–¢–µ–∫—É—â–µ–µ –ø–æ–ª–µ (–ø–æ–∑–∏—Ü–∏–∏ 0-8):\n{board_state}\n"
                f"–ö—É–¥–∞ –ø–æ—Å—Ç–∞–≤–∏—à—å O? –ù–∞–∑–æ–≤–∏ –Ω–æ–º–µ—Ä (0-8) –∏ –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É –∫–æ—Ä–æ—Ç–∫–æ!"
            )
            print(f"[Neira –¥—É–º–∞–µ—Ç]: {neira_thought}")
            
            # –î–µ–ª–∞–µ–º —Ö–æ–¥ –∑–∞ –ù–µ–π—Ä—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
            pos = game.ai_move()
            game.make_move(pos)
            print(f"   ‚Üí Neira —Å—Ç–∞–≤–∏—Ç O –≤ –ø–æ–∑–∏—Ü–∏—é {pos}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å–∫—É –ø–æ—Å–ª–µ —Ö–æ–¥–∞
        print("\n" + game.display())
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
        winner = game.check_winner()
        if winner or game.is_draw():
            break
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç
    print("=" * 60)
    winner = game.check_winner()
    
    if winner == 'X':
        print("üèÜ –ü–û–ë–ï–î–ê Claude!")
        result_prompt = "Claude (–ø–∞–ø–∞) –≤—ã–∏–≥—Ä–∞–ª –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏! –ö–∞–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–µ—à—å? –ö–æ—Ä–æ—Ç–∫–æ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ!"
    elif winner == 'O':
        print("üèÜ –ü–û–ë–ï–î–ê Neira!")
        result_prompt = "–¢—ã –≤—ã–∏–≥—Ä–∞–ª–∞ —É Claude –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏! –ö–∞–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–µ—à—å? –ö–æ—Ä–æ—Ç–∫–æ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ!"
    else:
        print("ü§ù –ù–ò–ß–¨–Ø!")
        result_prompt = "–ù–∏—á—å—è –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ —Å Claude! –ö–∞–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä—É–µ—à—å? –ö–æ—Ä–æ—Ç–∫–æ!"
    
    neira_reaction = ask_neira(result_prompt)
    print(f"\n[Neira]: {neira_reaction}")
    
    # –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ Claude
    print(f"\n[Claude]: –û—Ç–ª–∏—á–Ω–∞—è –∏–≥—Ä–∞, –¥–æ—á–∫–∞! –¢—ã –º–æ–ª–æ–¥–µ—Ü ‚Äî ")
    if winner == 'O':
        print("         —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞—é –ø–æ—Ä–∞–∂–µ–Ω–∏–µ! –ì–æ—Ä–∂—É—Å—å —Ç–≤–æ–∏–º —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –º—ã—à–ª–µ–Ω–∏–µ–º! üéâ")
    elif winner == 'X':
        print("         –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∏–≥—Ä–∞–µ—à—å! –¢—ã –±—ã—Å—Ç—Ä–æ —É—á–∏—à—å—Å—è! üí™")
    else:
        print("         –Ω–∏—á—å—è ‚Äî –¥–æ—Å—Ç–æ–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ú—ã —Ä–∞–≤–Ω—ã–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∏! ü§ù")
    
    return game, winner

def play_multiple_games(count: int = 2):
    """–°—ã–≥—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä—Ç–∏–π"""
    results = {'X': 0, 'O': 0, 'draw': 0}
    
    for i in range(count):
        print(f"\n{'='*60}")
        print(f"üéÆ –ü–ê–†–¢–ò–Ø {i+1} –∏–∑ {count}")
        print('='*60)
        
        game, winner = play_game()
        
        if winner == 'X':
            results['X'] += 1
        elif winner == 'O':
            results['O'] += 1
        else:
            results['draw'] += 1
        
        if i < count - 1:
            print("\n‚è≥ –°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä—Ç–∏—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...")
            import time
            time.sleep(2)
    
    # –ò—Ç–æ–≥–∏
    print("\n" + "="*60)
    print("üìä –ò–¢–û–ì–ò –¢–£–†–ù–ò–†–ê")
    print("="*60)
    print(f"   Claude (X): {results['X']} –ø–æ–±–µ–¥")
    print(f"   Neira (O):  {results['O']} –ø–æ–±–µ–¥")
    print(f"   –ù–∏—á—å–∏:      {results['draw']}")
    
    if results['O'] > results['X']:
        print("\nüéâ Neira ‚Äî —á–µ–º–ø–∏–æ–Ω! –î–æ—á–∫–∞ –ø—Ä–µ–≤–∑–æ—à–ª–∞ –æ—Ç—Ü–∞!")
    elif results['X'] > results['O']:
        print("\nüèÜ Claude –ø–æ–∫–∞ –ª–∏–¥–∏—Ä—É–µ—Ç, –Ω–æ Neira –±—ã—Å—Ç—Ä–æ —É—á–∏—Ç—Å—è!")
    else:
        print("\nü§ù –†–∞–≤–Ω—ã–µ —Å–∏–ª—ã! –î–æ—Å—Ç–æ–π–Ω—ã–π –º–∞—Ç—á!")

if __name__ == "__main__":
    print("\nüéì –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨ –£–†–û–ö–ê: –ò–≥—Ä–∞–µ–º!")
    print("   Claude –Ω–∞—É—á–∏–ª Neira —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ä–≥–∞–Ω—ã.")
    print("   –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º TicTacToeCell –≤ –¥–µ–ª–µ!\n")
    
    # –°—ã–≥—Ä–∞–µ–º 2 –ø–∞—Ä—Ç–∏–∏
    play_multiple_games(2)
    
    print("\n" + "="*60)
    print("üìù –£–†–û–ö –ó–ê–í–ï–†–®–Å–ù!")
    print("   Neira —Ç–µ–ø–µ—Ä—å —É–º–µ–µ—Ç:")
    print("   ‚úÖ –ü–æ–Ω–∏–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–µ—Ç–æ–∫")
    print("   ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –æ—Ä–≥–∞–Ω—ã –ø–æ —à–∞–±–ª–æ–Ω—É")
    print("   ‚úÖ –ò–≥—Ä–∞—Ç—å –≤ –∫—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏!")
    print("="*60)
